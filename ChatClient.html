<!DOCTYPE html>
<html>
   <head>
      <!--<link rel="stylesheet" type="text/css" href="chatStyle.css">  not working-->
      <style>
         #content{
            display:none;
         }
         #chatRoom{
            display:none;
            float:left;
            width:500px;
            border:1px solid;
         }
         .error{
            color:red;
         }
         .private{
            color:blue;
         }
         #users{
            display: inline-block;
            float:right;
            width:100px;
            margin: 10px auto;
         }
      </style>
      <title>ChatRoom</title>
   </head>
   <body>
      
      <div id="loginWrap">
         
         <p>Enter a Username:</p>
         <form id="login">
            <input type="text" id="username"/>
            <input type="submit"/>
         </form>
         <p id="error"></p>
         
      </div>
      <div id="content">
         
         <div id="roomSelect">
            <div id="rooms"></div>
            <p id="roomError"></p>
            <p>Please select a room from the list above or click new room:</p>
            <form id="pickRoom">
               <label>room name</label>
               <input type="text" id="roomName"/>
               <label>password</label>
               <input type="password" id="pass"/>
               <input type="submit"/>
               <input type="button" value="new" id="newRoom"/>
            </form>
         </div>
         
         <div id="chatRoom">
            <div id="messages"></div>
            <form id="sendForm">
               <input size="35" id="messageInput"/>
               <button type="submit">send</button>
               <button type="button" id="leave">leave</button>
            </form>
            <div id="users"></div>
            <p>Type "/p username message here" to send a private message</p>
         </div>
         
      </div>
      
      <script src="http://code.jquery.com/jquery-latest.min.js"></script>
      <script src="/socket.io/socket.io.js"></script>
      <script>
         jQuery(function($){
            var socket = io.connect();
            //login form variables
            var $loginWrap = $('#loginWrap');
            var $loginForm = $('#login');
            var $userError = $('#error');
            var $loginInput = $('#username');
            //chat form variables
            var $form = $('#sendForm');
            var $chatInput = $('#messageInput');
            var $chatBox = $('#messages');
            var $content = $('#content');
            var $chatRoom = $('#chatRoom');
            //users
            var $users = $('#users');
            //room selection
            var $roomForm = $('#pickRoom');
            var $rooms = $('#rooms');
            var $roomInput = $('#roomName');
            var $roomDiv = $('#roomSelect');
            var $password = $('#pass');
            var $newButton = $('#newRoom');
            var $leave = $('#leave');
            
            
            $leave.click(function(e){
               e.preventDefault();
               socket.emit('leave', function(){});
               $chatBox.empty();
               $chatRoom.hide();
               $roomDiv.show();
            });
            //Login submission
            $loginForm.submit(function(e){
               e.preventDefault();
               socket.emit('newUser', $loginInput.val(), function(data){
                  if (data) {
                     $('#title').html(': ' + $loginInput.val());
                     $loginWrap.hide('fast');
                     $content.show('fast');
                  }
                  else{
                     $userError.html('<span class="error">Username already taken, try a different one!</span>');
                  }
               });
               $loginInput.val('');
            });
            //create a new room
            $newButton.click(function(e){
               e.preventDefault();
               socket.emit('newRoom', {name: $roomInput.val(), pass: $password.val()}, function(data){
                  if (data) {
                     $roomDiv.hide('fast');
                     $chatRoom.show('fast');
                  }
                  else{
                        $('#roomError').html('<span class="error">Room already exists!</span>');
                  }
               });
            });
            
            //room selection submission
            $roomForm.submit(function(e){
               e.preventDefault();
               console.log($roomInput.val());
               console.log($password.val());
               socket.emit('pickRoom', {name: $roomInput.val(), pass: $password.val()}, function(data){
                  if (data === 2) {
                     $('#roomError').html('<span class="error">No such room exists, try another</span>');
                  }
                  else if(data ===1){
                     $('#roomError').html('<span class="error">Incorrect password</span>');
                  }
                  else if (data === 0){
                     $roomDiv.hide('fast');
                     $chatRoom.show('fast');
                  }
                  else if (data === 3){
                     $('#roomError').html('<span class="error">You have been banned from this room</span>');
                  }
               });
               $roomInput.val('');
            });
            
            //update the users
            socket.on('users', function(data){
               var html = data;
               $users.html(html);
            });
           
           //send a message
            $form.submit(function(e){
               e.preventDefault();
               socket.emit('send', $chatInput.val(), function(data){
               $chatBox.append('<span class="error">' + data + '</span><br/>');
               });
               $chatInput.val('');
            });
            
            socket.on('newImg', function(data){
               $chatBox.append('<b>' + data.user + ': </b>' + '<img src="' + data.msg + '" alt="" height="100" width="100"><br/>');
            });
            
            socket.on('newGoog', function(data){
               $chatBox.append('<b>' + data.user + ': </b>' + '<a href="' + data.msg + '" target="_blank">lmgtfy</a><br/>')
            })
            //incoming message
            socket.on('new', function(data){
               $chatBox.append('<b>' + data.user + ': </b>' + data.msg + '<br/>');
            });
            
            //incoming private message
            socket.on('private', function(data){
               $chatBox.append('<span class="private"><b>' + data.user + ': </b>' + data.msg + '</span><br/>');
            });
            //update the rooms
            socket.on('rooms', function(data){
               var html = '';
               for(var i =0; i < data.length; i++){
                  html += data[i] + '<br/>';
               }
               $rooms.empty();
               $rooms.append(html);
            });
            //kicked out of room
            socket.on('kick', function(data){
               $('roomError').html('<span class="error">'  + 'You have been kicked out of the room, but may re-enter' + '</span>');
               $chatBox.empty();
               $chatRoom.hide();
               $roomDiv.show();
            });
         });
         
      </script>
   </body>
</html>